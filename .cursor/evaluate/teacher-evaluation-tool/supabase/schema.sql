-- 学生表
CREATE TABLE students (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  student_number TEXT UNIQUE,
  class TEXT DEFAULT '二年1班',
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW())
);

-- 教学进度基准表（预置数据）
CREATE TABLE teaching_progress (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  week_number INTEGER NOT NULL,
  subject TEXT NOT NULL,
  chapter TEXT,
  key_points TEXT,
  evaluation_type TEXT, -- '识字量' | '口算速度' | '阅读' 等
  is_node BOOLEAN DEFAULT FALSE,
  semester INTEGER DEFAULT 1
);

-- 评价记录主表
CREATE TABLE evaluation_records (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id uuid REFERENCES students(id) ON DELETE CASCADE,
  evaluator_id uuid, -- 教师ID（预留）
  week_number INTEGER NOT NULL,
  domain TEXT NOT NULL, -- '学科素养' | '品德发展' 等
  indicator_code TEXT NOT NULL, -- '语文_识字写字'
  star_rating SMALLINT CHECK (star_rating BETWEEN 1 AND 3),
  evidence TEXT NOT NULL,
  raw_data JSONB, -- 存储定量数据如 {"words_per_minute": 125}
  work_sample_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW())
);

-- 教师用户表（作为Supabase Auth的扩展）
CREATE TABLE teacher_profiles (
  id uuid REFERENCES auth.users(id) PRIMARY KEY,
  name TEXT NOT NULL,
  class TEXT NOT NULL,
  email TEXT UNIQUE
);

-- 报告表
CREATE TABLE reports (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id uuid REFERENCES students(id) ON DELETE CASCADE,
  report_type TEXT NOT NULL, -- '学期初诊断' | '学期中发展' | '学期末总结'
  report_data JSONB NOT NULL,
  generated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW())
);

-- 启用RLS（Row Level Security）
ALTER TABLE evaluation_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;

-- 创建策略：教师只能查看自己班级的数据
CREATE POLICY "教师查看本班评价" ON evaluation_records
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM teacher_profiles
      WHERE teacher_profiles.id = auth.uid()
      AND teacher_profiles.class = (
        SELECT class FROM students WHERE students.id = evaluation_records.student_id
      )
    )
  );

CREATE POLICY "教师插入本班评价" ON evaluation_records
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM teacher_profiles
      WHERE teacher_profiles.id = auth.uid()
      AND teacher_profiles.class = (
        SELECT class FROM students WHERE students.id = evaluation_records.student_id
      )
    )
  );

CREATE POLICY "教师查看本班学生" ON students
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM teacher_profiles
      WHERE teacher_profiles.id = auth.uid()
      AND teacher_profiles.class = students.class
    )
  );

-- 创建索引优化查询
CREATE INDEX idx_evaluation_records_student_id ON evaluation_records(student_id);
CREATE INDEX idx_evaluation_records_week_number ON evaluation_records(week_number);
CREATE INDEX idx_evaluation_records_domain ON evaluation_records(domain);
CREATE INDEX idx_teaching_progress_week ON teaching_progress(week_number, is_node);


