-- 教师评价系统数据库表结构（合并版本 - 使用统一的 students 表）
-- 此版本会修改现有的 students 表，添加教师评价系统需要的字段
-- 在 Supabase SQL Editor 中执行此脚本

-- 检查并添加教师评价系统需要的字段到 students 表
DO $$
BEGIN
    -- 如果 students 表存在但缺少 teacher_students 需要的字段，则添加
    IF EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'students') THEN
        -- 添加 student_number 字段（如果不存在）
        IF NOT EXISTS (SELECT FROM information_schema.columns 
                      WHERE table_name = 'students' AND column_name = 'student_number') THEN
            ALTER TABLE students ADD COLUMN student_number TEXT UNIQUE;
        END IF;
        
        -- 添加 class 字段（如果不存在）
        IF NOT EXISTS (SELECT FROM information_schema.columns 
                      WHERE table_name = 'students' AND column_name = 'class') THEN
            ALTER TABLE students ADD COLUMN class TEXT DEFAULT '二年1班';
        END IF;
        
        -- 如果 id 是 BIGSERIAL，需要创建一个新的 UUID 类型的 id
        -- 但为了兼容性，我们保留原有结构，使用 user_id 作为关联
    END IF;
END $$;

-- 如果 students 表不存在，创建新表（兼容两种结构）
CREATE TABLE IF NOT EXISTS students (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    gender TEXT,
    birth_date DATE,
    height NUMERIC,
    weight NUMERIC,
    notes TEXT,
    -- 教师评价系统字段
    student_number TEXT UNIQUE,
    class TEXT DEFAULT '二年1班',
    avatar_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id)
);

-- 教学进度基准表（预置数据）
CREATE TABLE IF NOT EXISTS teaching_progress (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    week_number INTEGER NOT NULL,
    subject TEXT NOT NULL,
    chapter TEXT,
    key_points TEXT,
    evaluation_type TEXT, -- '识字量' | '口算速度' | '阅读' 等
    is_node BOOLEAN DEFAULT FALSE,
    semester INTEGER DEFAULT 1
);

-- 评价记录主表
-- 注意：这里使用 BIGINT student_id 来兼容现有的 students 表结构
CREATE TABLE IF NOT EXISTS evaluation_records (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id BIGINT REFERENCES students(id) ON DELETE CASCADE,
    evaluator_id uuid, -- 教师ID（预留）
    week_number INTEGER NOT NULL,
    domain TEXT NOT NULL, -- '学科素养' | '品德发展' 等
    indicator_code TEXT NOT NULL, -- '语文_识字写字'
    star_rating SMALLINT CHECK (star_rating BETWEEN 1 AND 3),
    evidence TEXT NOT NULL,
    raw_data JSONB, -- 存储定量数据如 {"words_per_minute": 125}
    work_sample_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW())
);

-- 教师用户表（作为Supabase Auth的扩展）
CREATE TABLE IF NOT EXISTS teacher_profiles (
    id uuid REFERENCES auth.users(id) PRIMARY KEY,
    name TEXT NOT NULL,
    class TEXT NOT NULL,
    email TEXT UNIQUE
);

-- 报告表
CREATE TABLE IF NOT EXISTS reports (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id BIGINT REFERENCES students(id) ON DELETE CASCADE,
    report_type TEXT NOT NULL, -- '学期初诊断' | '学期中发展' | '学期末总结'
    report_data JSONB NOT NULL,
    generated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW())
);

-- 创建索引优化查询
CREATE INDEX IF NOT EXISTS idx_evaluation_records_student_id ON evaluation_records(student_id);
CREATE INDEX IF NOT EXISTS idx_evaluation_records_week_number ON evaluation_records(week_number);
CREATE INDEX IF NOT EXISTS idx_evaluation_records_domain ON evaluation_records(domain);
CREATE INDEX IF NOT EXISTS idx_teaching_progress_week ON teaching_progress(week_number, is_node);
CREATE INDEX IF NOT EXISTS idx_students_class ON students(class);
CREATE INDEX IF NOT EXISTS idx_students_student_number ON students(student_number);

-- 启用RLS（Row Level Security）
ALTER TABLE evaluation_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;

-- 删除已存在的策略（如果存在）
DROP POLICY IF EXISTS "教师查看本班评价" ON evaluation_records;
DROP POLICY IF EXISTS "教师插入本班评价" ON evaluation_records;
DROP POLICY IF EXISTS "教师更新本班评价" ON evaluation_records;
DROP POLICY IF EXISTS "教师查看本班学生" ON students;
DROP POLICY IF EXISTS "教师插入本班学生" ON students;
DROP POLICY IF EXISTS "教师更新本班学生" ON students;
DROP POLICY IF EXISTS "教师查看本班报告" ON reports;

-- 创建策略：教师只能查看自己班级的数据
CREATE POLICY "教师查看本班评价" ON evaluation_records
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = (
                SELECT class FROM students WHERE students.id = evaluation_records.student_id
            )
        )
    );

CREATE POLICY "教师插入本班评价" ON evaluation_records
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = (
                SELECT class FROM students WHERE students.id = evaluation_records.student_id
            )
        )
    );

CREATE POLICY "教师更新本班评价" ON evaluation_records
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = (
                SELECT students.class FROM students WHERE students.id = evaluation_records.student_id
            )
        )
    );

CREATE POLICY "教师查看本班学生" ON students
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = students.class
        )
        OR user_id = auth.uid()  -- 用户也可以查看自己的学生信息
    );

CREATE POLICY "教师插入本班学生" ON students
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = students.class
        )
        OR user_id = auth.uid()  -- 用户也可以插入自己的学生信息
    );

CREATE POLICY "教师更新本班学生" ON students
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = students.class
        )
        OR user_id = auth.uid()  -- 用户也可以更新自己的学生信息
    );

CREATE POLICY "教师查看本班报告" ON reports
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = (
                SELECT class FROM students WHERE students.id = reports.student_id
            )
        )
    );

-- 创建获取预警学生的函数
CREATE OR REPLACE FUNCTION get_risk_students()
RETURNS TABLE (
    id BIGINT,
    name TEXT,
    class TEXT,
    risk_count BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        s.id,
        s.name,
        COALESCE(s.class, '未分班') as class,
        COUNT(*) as risk_count
    FROM students s
    INNER JOIN evaluation_records er ON er.student_id = s.id
    WHERE er.star_rating = 1
    GROUP BY s.id, s.name, s.class
    HAVING COUNT(*) >= 3
    ORDER BY risk_count DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

