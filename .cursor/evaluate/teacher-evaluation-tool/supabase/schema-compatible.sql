-- 教师评价系统数据库表结构（兼容版本）
-- 此脚本会检查表是否存在，如果存在则跳过创建
-- 在 Supabase SQL Editor 中执行此脚本

-- 检查并创建学生表（教师评价系统专用）
-- 注意：如果已存在儿童测评系统的 students 表，我们需要创建一个新表
DO $$
BEGIN
    -- 检查是否存在 teacher_students 表，如果不存在则创建
    IF NOT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'teacher_students') THEN
        CREATE TABLE teacher_students (
            id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
            name TEXT NOT NULL,
            student_number TEXT UNIQUE,
            class TEXT DEFAULT '二年1班',
            avatar_url TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW())
        );
        
        -- 创建索引
        CREATE INDEX IF NOT EXISTS idx_teacher_students_class ON teacher_students(class);
        CREATE INDEX IF NOT EXISTS idx_teacher_students_student_number ON teacher_students(student_number);
    END IF;
END $$;

-- 教学进度基准表（预置数据）
CREATE TABLE IF NOT EXISTS teaching_progress (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    week_number INTEGER NOT NULL,
    subject TEXT NOT NULL,
    chapter TEXT,
    key_points TEXT,
    evaluation_type TEXT, -- '识字量' | '口算速度' | '阅读' 等
    is_node BOOLEAN DEFAULT FALSE,
    semester INTEGER DEFAULT 1
);

-- 评价记录主表
-- 使用 teacher_students 表而不是 students 表
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'evaluation_records') THEN
        CREATE TABLE evaluation_records (
            id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
            student_id uuid REFERENCES teacher_students(id) ON DELETE CASCADE,
            evaluator_id uuid, -- 教师ID（预留）
            week_number INTEGER NOT NULL,
            domain TEXT NOT NULL, -- '学科素养' | '品德发展' 等
            indicator_code TEXT NOT NULL, -- '语文_识字写字'
            star_rating SMALLINT CHECK (star_rating BETWEEN 1 AND 3),
            evidence TEXT NOT NULL,
            raw_data JSONB, -- 存储定量数据如 {"words_per_minute": 125}
            work_sample_url TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW())
        );
        
        -- 创建索引
        CREATE INDEX IF NOT EXISTS idx_evaluation_records_student_id ON evaluation_records(student_id);
        CREATE INDEX IF NOT EXISTS idx_evaluation_records_week_number ON evaluation_records(week_number);
        CREATE INDEX IF NOT EXISTS idx_evaluation_records_domain ON evaluation_records(domain);
    END IF;
END $$;

-- 教师用户表（作为Supabase Auth的扩展）
CREATE TABLE IF NOT EXISTS teacher_profiles (
    id uuid REFERENCES auth.users(id) PRIMARY KEY,
    name TEXT NOT NULL,
    class TEXT NOT NULL,
    email TEXT UNIQUE
);

-- 报告表
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'reports') THEN
        CREATE TABLE reports (
            id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
            student_id uuid REFERENCES teacher_students(id) ON DELETE CASCADE,
            report_type TEXT NOT NULL, -- '学期初诊断' | '学期中发展' | '学期末总结'
            report_data JSONB NOT NULL,
            generated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::TEXT, NOW())
        );
    END IF;
END $$;

-- 创建索引优化查询
CREATE INDEX IF NOT EXISTS idx_teaching_progress_week ON teaching_progress(week_number, is_node);

-- 启用RLS（Row Level Security）
ALTER TABLE evaluation_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE teacher_students ENABLE ROW LEVEL SECURITY;
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;

-- 删除已存在的策略（如果存在）
DROP POLICY IF EXISTS "教师查看本班评价" ON evaluation_records;
DROP POLICY IF EXISTS "教师插入本班评价" ON evaluation_records;
DROP POLICY IF EXISTS "教师更新本班评价" ON evaluation_records;
DROP POLICY IF EXISTS "教师查看本班学生" ON teacher_students;
DROP POLICY IF EXISTS "教师插入本班学生" ON teacher_students;
DROP POLICY IF EXISTS "教师更新本班学生" ON teacher_students;
DROP POLICY IF EXISTS "教师查看本班报告" ON reports;

-- 创建策略：教师只能查看自己班级的数据
CREATE POLICY "教师查看本班评价" ON evaluation_records
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = (
                SELECT class FROM teacher_students WHERE teacher_students.id = evaluation_records.student_id
            )
        )
    );

CREATE POLICY "教师插入本班评价" ON evaluation_records
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = (
                SELECT class FROM teacher_students WHERE teacher_students.id = evaluation_records.student_id
            )
        )
    );

CREATE POLICY "教师更新本班评价" ON evaluation_records
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = (
                SELECT class FROM teacher_students WHERE teacher_students.id = evaluation_records.student_id
            )
        )
    );

CREATE POLICY "教师查看本班学生" ON teacher_students
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = teacher_students.class
        )
    );

CREATE POLICY "教师插入本班学生" ON teacher_students
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = teacher_students.class
        )
    );

CREATE POLICY "教师更新本班学生" ON teacher_students
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = teacher_students.class
        )
    );

CREATE POLICY "教师查看本班报告" ON reports
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM teacher_profiles
            WHERE teacher_profiles.id = auth.uid()
            AND teacher_profiles.class = (
                SELECT class FROM teacher_students WHERE teacher_students.id = reports.student_id
            )
        )
    );

-- 创建获取预警学生的函数
CREATE OR REPLACE FUNCTION get_risk_students()
RETURNS TABLE (
    id uuid,
    name TEXT,
    class TEXT,
    risk_count BIGINT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        s.id,
        s.name,
        s.class,
        COUNT(*) as risk_count
    FROM teacher_students s
    INNER JOIN evaluation_records er ON er.student_id = s.id
    WHERE er.star_rating = 1
    GROUP BY s.id, s.name, s.class
    HAVING COUNT(*) >= 3
    ORDER BY risk_count DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

